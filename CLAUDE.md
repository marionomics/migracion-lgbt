# CLAUDE.md

## Project Overview

Research project studying whether the staggered legalization of same-sex marriage (SSM) across Mexican states (2010--2023) is associated with internal migration of LGB+ individuals toward more inclusive jurisdictions. Uses ENOE (employment survey) and ENDISEG (sexual diversity survey) microdata from INEGI.

## Project Structure

- `analysis/` — R analysis scripts, numbered 01--05 by pipeline order
- `scripts/` — Python data pipeline, numbered 01--05
- `r/` — R utility functions (`transform_database.R`, `plots.R`, `descriptive.R`, plus `r/models/`)
- `auxiliary/` — Reference CSVs: `equal_marriage.csv` (legalization dates), `columns.csv` (ENOE variables), `states.csv` (state codes)
- `data/` — All data (gitignored). Generated by Python pipeline + manual ENDISEG download
- `notebooks/` — Jupyter notebooks for exploration
- `Notes/` — Documentation: codebooks, data sources, methodology
- `tables/` — LaTeX regression tables
- `img/` — Output figures (PNG)
- `archive/` — Superseded scripts from exploratory phase

## Key Technical Details

- **Working directory**: All R scripts assume the project root as working directory (set by `.Rproj`). Do not change `setwd()`.
- **ENOE encoding**: Raw ENOE CSVs use Latin-1 encoding, not UTF-8.
- **Survey weights**: ENDISEG analyses MUST use `svydesign(weights = ~factor)` from the `survey` package. Never use unweighted `lm()`/`glm()`/`mean()` on ENDISEG data.
- **ENDISEG loading**: Scripts 01--03 in `analysis/` expect `endiseg` to already be loaded in the R environment before sourcing.
- **Treatment definitions**: Two are used — "early adopters" (16 states with SSM before 2021) and "gold standard" (4 states with SSM + civil union + adoption: CDMX, Coahuila, Campeche, Michoacan).
- **Staggered DiD**: Uses `fixest` package for event study and `bacondecomp` for decomposition. Standard errors clustered at state level.

## Languages and Dependencies

- **R** (4.0+): tidyverse, survey, scales, ggthemes, strucchange, fixest, bacondecomp, haven, lfe, estimatr, plm, readxl
- **Python** (3.8+): pandas, numpy, matplotlib, seaborn, geopandas, scipy, statsmodels (see `requirements.txt`)

## Build / Run

```bash
# Python pipeline (from project root)
python scripts/01_download_ENOE.py      # Download ENOE microdata (~5 GB)
python scripts/02_create_dataset.py     # Build data/ENOE/final/lgbt_migration.csv

# R analysis (open migracion-lgbt.Rproj in RStudio first)
# Load ENDISEG, then source analysis/01 through analysis/05 in order

# Python figures
python scripts/03_plot_migration.py
python scripts/04_timeline.py
python scripts/05_time_map.py
```

## Conventions

- Manuscript is under review; the `paper/` directory is not committed
- `data/` is gitignored; replicators must run the pipeline or download manually
- State codes are 1--32 matching INEGI's standard (see `auxiliary/states.csv`)
